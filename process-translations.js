import XLSX from 'xlsx';
import fs from 'fs';

// Функция для перевода текста с русского на иврит
function translateToHebrew(russianText) {
  // Базовые переводы для общих слов
  const translations = {
    // Общие слова
    'Да': 'כן',
    'Нет': 'לא',
    'Пожалуйста': 'בבקשה',
    'Спасибо': 'תודה',
    'Извините': 'סליחה',
    'Здравствуйте': 'שלום',
    'До свидания': 'להתראות',
    'Хорошо': 'טוב',
    'Плохо': 'רע',
    'Большой': 'גדול',
    'Маленький': 'קטן',
    'Новый': 'חדש',
    'Старый': 'ישן',
    'Горячий': 'חם',
    'Холодный': 'קר',
    'Быстро': 'מהר',
    'Медленно': 'לאט',
    
    // Еда и напитки
    'Еда': 'אוכל',
    'Напитки': 'משקאות',
    'Мясо': 'בשר',
    'Курица': 'עוף',
    'Рыба': 'דג',
    'Овощи': 'ירקות',
    'Фрукты': 'פירות',
    'Хлеб': 'לחם',
    'Молоко': 'חלב',
    'Сыр': 'גבינה',
    'Яйца': 'ביצים',
    'Рис': 'אורז',
    'Макароны': 'פסטה',
    'Салат': 'סלט',
    'Суп': 'מרק',
    'Пицца': 'פיצה',
    'Бургер': 'המבורגר',
    'Кофе': 'קפה',
    'Чай': 'תה',
    'Вода': 'מים',
    'Сок': 'מיץ',
    'Пиво': 'בירה',
    'Вино': 'יין',
    
    // Магазин и покупки
    'Магазин': 'חנות',
    'Продукты': 'מוצרים',
    'Цена': 'מחיר',
    'Скидка': 'הנחה',
    'Оплата': 'תשלום',
    'Заказ': 'הזמנה',
    'Доставка': 'משלוח',
    'Корзина': 'עגלה',
    'Покупка': 'קנייה',
    'Продажа': 'מכירה',
    'Клиент': 'לקוח',
    'Услуга': 'שירות',
    'Качество': 'איכות',
    'Количество': 'כמות',
    'Размер': 'גודל',
    'Цвет': 'צבע',
    'Бренд': 'מותג',
    'Категория': 'קטגוריה',
    
    // Время и дни
    'Время': 'זמן',
    'День': 'יום',
    'Ночь': 'לילה',
    'Утром': 'בבוקר',
    'Днем': 'בצהריים',
    'Вечером': 'בערב',
    'Понедельник': 'יום שני',
    'Вторник': 'יום שלישי',
    'Среда': 'יום רביעי',
    'Четверг': 'יום חמישי',
    'Пятница': 'יום שישי',
    'Суббота': 'שבת',
    'Воскресенье': 'יום ראשון',
    
    // Интерфейс и навигация
    'Главная': 'עמוד הבית',
    'Меню': 'תפריט',
    'Поиск': 'חיפוש',
    'Настройки': 'הגדרות',
    'Помощь': 'עזרה',
    'Контакты': 'צור קשר',
    'О нас': 'אודותינו',
    'Войти': 'התחברות',
    'Выйти': 'יציאה',
    'Регистрация': 'הרשמה',
    'Профиль': 'פרופיל',
    'Аккаунт': 'חשבון',
    'Пароль': 'סיסמה',
    'Email': 'אימייל',
    'Телефон': 'טלפון',
    'Адрес': 'כתובת',
    'Город': 'עיר',
    'Страна': 'מדינה',
    
    // Действия
    'Добавить': 'הוסף',
    'Удалить': 'מחק',
    'Изменить': 'שנה',
    'Сохранить': 'שמור',
    'Отменить': 'בטל',
    'Подтвердить': 'אשר',
    'Отправить': 'שלח',
    'Получить': 'קבל',
    'Открыть': 'פתח',
    'Закрыть': 'סגור',
    'Начать': 'התחל',
    'Закончить': 'סיים',
    'Продолжить': 'המשך',
    'Остановить': 'עצור',
    'Играть': 'נגן',
    'Пауза': 'השהה',
    
    // Статус и состояния
    'Активный': 'פעיל',
    'Неактивный': 'לא פעיל',
    'Доступно': 'זמין',
    'Недоступно': 'לא זמין',
    'В наличии': 'במלאי',
    'Нет в наличии': 'אזל מהמלאי',
    'Готов': 'מוכן',
    'В процессе': 'בתהליך',
    'Завершено': 'הושלם',
    'Отменено': 'בוטל',
    'Ошибка': 'שגיאה',
    'Успешно': 'בהצלחה',
    
    // Числа
    'Один': 'אחד',
    'Два': 'שניים',
    'Три': 'שלושה',
    'Четыре': 'ארבעה',
    'Пять': 'חמישה',
    'Шесть': 'שישה',
    'Семь': 'שבעה',
    'Восемь': 'שמונה',
    'Девять': 'תשעה',
    'Десять': 'עשרה',
    
    // Специфичные для eDAHouse
    'eDAHouse': 'eDAHouse',
    'Добро пожаловать': 'ברוכים הבאים',
    'Свежие продукты': 'מוצרים טריים',
    'Быстрая доставка': 'משלוח מהיר',
    'Лучшие цены': 'המחירים הטובים ביותר',
    'Качественное питание': 'תזונה איכותית',
    'Здоровая еда': 'אוכל בריא',
    'Семейное меню': 'תפריט משפחתי',
    'Детское питание': 'אוכל לילדים',
    'Вегетарианское': 'צמחוני',
    'Веганское': 'טבעוני',
    'Без глютена': 'ללא גלוטן',
    'Органическое': 'אורגני',
    'Домашняя кухня': 'מטבח ביתי',
    'Традиционные блюда': 'מנות מסורתיות',
    'Современная кухня': 'מטבח מודרני',
    
    // Описания блюд
    'Салаты': 'סלטים',
    'Закуски': 'מזנונים',
    'Первые блюда': 'מנות ראשונות',
    'Вторые блюда': 'מנות עיקריות',
    'Десерты': 'קינוחים',
    'Выпечка': 'מאפים',
    'Соусы': 'רטבים',
    'Приправы': 'תבלינים',
    'Консервы': 'שימורים',
    'Заморозка': 'קפואים',
    'Свежее': 'טרי',
    'Охлажденное': 'מקורר',
    
    // Кулинарные термины
    'Жареное': 'מטוגן',
    'Вареное': 'מבושל',
    'Тушеное': 'מבושל לאט',
    'Печеное': 'אפוי',
    'Сырое': 'נא',
    'Маринованное': 'כבוש',
    'Соленое': 'מלוח',
    'Сладкое': 'מתוק',
    'Кислое': 'חמוץ',
    'Острое': 'חריף',
    'Пряное': 'מתובל',
    'Копченое': 'מעושן',
    
    // Упаковка и порции
    'Порция': 'מנה',
    'Штука': 'יחידה',
    'Килограмм': 'קילוגרם',
    'Грамм': 'גרם',
    'Литр': 'ליטר',
    'Миллилитр': 'מיליליטר',
    'Упаковка': 'אריזה',
    'Банка': 'צנצנת',
    'Бутылка': 'בקבוק',
    'Пакет': 'שקית',
    'Коробка': 'קופסה',
    
    // Административные термины
    'Администратор': 'מנהל',
    'Пользователь': 'משתמש',
    'Модератор': 'מנהל',
    'Сотрудник': 'עובד',
    'Менеджер': 'מנהל',
    'Кассир': 'קופאי',
    'Повар': 'טבח',
    'Курьер': 'שליח',
    'Склад': 'מחסן',
    'Касса': 'קופה',
    'Кухня': 'מטבח',
    'Зал': 'אולם',
    
    // Время работы
    'Открыто': 'פתוח',
    'Закрыто': 'סגור',
    'Круглосуточно': '24 שעות',
    'Рабочие дни': 'ימי עבודה',
    'Выходные': 'סוף השבוע',
    'Праздники': 'חגים',
    'Обеденный перерыв': 'הפסקת צהריים',
    
    // Способы оплаты
    'Наличные': 'מזומן',
    'Карта': 'כרטיס',
    'Перевод': 'העברה',
    'Онлайн': 'אונליין',
    'Предоплата': 'תשלום מראש',
    'При получении': 'בעת קבלה',
    
    // Статусы заказа
    'Новый': 'חדש',
    'Принят': 'מאושר',
    'Готовится': 'בהכנה',
    'Готов': 'מוכן',
    'В пути': 'בדרך',
    'Доставлен': 'נמסר',
    'Отклонен': 'נדחה',
    
    // Рейтинги и отзывы
    'Отлично': 'מעולה',
    'Хорошо': 'טוב',
    'Удовлетворительно': 'בסדר',
    'Плохо': 'רע',
    'Ужасно': 'נורא',
    'Рейтинг': 'דירוג',
    'Отзыв': 'ביקורת',
    'Комментарий': 'הערה',
    'Рекомендация': 'המלצה'
  };
  
  // Если текст найден в словаре переводов
  if (translations[russianText]) {
    return translations[russianText];
  }
  
  // Для составных фраз попробуем перевести по словам
  const words = russianText.split(' ');
  const translatedWords = words.map(word => {
    // Убираем знаки препинания для поиска
    const cleanWord = word.replace(/[.,!?;:()]/g, '');
    return translations[cleanWord] || word;
  });
  
  // Если хотя бы одно слово переведено, возвращаем результат
  if (translatedWords.some((word, index) => word !== words[index].replace(/[.,!?;:()]/g, ''))) {
    return translatedWords.join(' ');
  }
  
  // Если перевод не найден, возвращаем оригинальный текст
  return russianText;
}

// Функция для проверки, является ли строка ссылкой
function isURL(str) {
  if (!str || typeof str !== 'string') return false;
  return str.startsWith('http://') || str.startsWith('https://') || str.startsWith('www.') || str.includes('.com') || str.includes('.ru') || str.includes('.co.il');
}

// Обработка файла
try {
  console.log('Читаем файл переводов...');
  const workbook = XLSX.readFile('attached_assets/translations_2025-08-26_1756220852157.xlsx');
  const sheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[sheetName];
  
  console.log('Конвертируем в JSON...');
  const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
  
  if (data.length === 0) {
    console.log('Файл пустой');
    process.exit(1);
  }
  
  // Находим индексы нужных колонок
  const headers = data[0];
  console.log('Заголовки:', headers);
  
  const russianIndex = headers.findIndex(h => h && h.includes('Russian') || h && h.includes('RU'));
  const hebrewIndex = headers.findIndex(h => h && h.includes('Hebrew') || h && h.includes('HE'));
  
  console.log(`Индекс русской колонки: ${russianIndex}`);
  console.log(`Индекс ивритской колонки: ${hebrewIndex}`);
  
  if (russianIndex === -1) {
    console.log('Колонка Russian (RU) не найдена');
    process.exit(1);
  }
  
  if (hebrewIndex === -1) {
    console.log('Колонка Hebrew (HE) не найдена');
    process.exit(1);
  }
  
  let translatedCount = 0;
  let skippedCount = 0;
  let urlCount = 0;
  
  // Обрабатываем каждую строку
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    
    const russianText = row[russianIndex];
    
    if (!russianText || russianText.trim() === '') {
      continue; // Пропускаем пустые ячейки
    }
    
    // Проверяем, является ли текст ссылкой
    if (isURL(russianText)) {
      console.log(`Строка ${i}: Пропускаем ссылку: ${russianText}`);
      row[hebrewIndex] = ''; // Оставляем пустой для ссылок
      urlCount++;
      continue;
    }
    
    // Проверяем, есть ли уже перевод
    if (row[hebrewIndex] && row[hebrewIndex].trim() !== '') {
      console.log(`Строка ${i}: Перевод уже существует: ${row[hebrewIndex]}`);
      skippedCount++;
      continue;
    }
    
    // Переводим текст
    const hebrewTranslation = translateToHebrew(russianText.trim());
    row[hebrewIndex] = hebrewTranslation;
    
    console.log(`Строка ${i}: "${russianText}" -> "${hebrewTranslation}"`);
    translatedCount++;
  }
  
  console.log(`\nОбработка завершена:`);
  console.log(`- Переведено: ${translatedCount} строк`);
  console.log(`- Пропущено (уже переведено): ${skippedCount} строк`);
  console.log(`- Пропущено (ссылки): ${urlCount} строк`);
  
  // Сохраняем обновленный файл
  const newWorkbook = XLSX.utils.book_new();
  const newWorksheet = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Translations');
  
  const outputFileName = 'attached_assets/translations_with_hebrew_2025-08-26.xlsx';
  XLSX.writeFile(newWorkbook, outputFileName);
  
  console.log(`\nФайл сохранен как: ${outputFileName}`);
  
} catch (error) {
  console.error('Ошибка при обработке файла:', error);
  process.exit(1);
}