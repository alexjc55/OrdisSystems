# 🚀 Автоматическая система развертывания с кеш-бастингом

## Как это работает

### 🔄 Автоматическое определение изменений

Система теперь **автоматически определяет изменения файлов** и уведомляет пользователей:

1. **Хеш файлов**: Сервер генерирует MD5 хеш основных файлов (App.tsx, routes.ts, package.json, etc.)
2. **Периодическая проверка**: Каждые 30 секунд клиент проверяет изменения через `/api/version`
3. **Автоматические уведомления**: Пользователи получают уведомление об обновлении
4. **Очистка кеша**: Service Worker автоматически очищает старые кеши

### 📁 Отслеживаемые файлы

Система отслеживает изменения в:
- `package.json` - изменения зависимостей
- `client/src/App.tsx` - основной компонент
- `client/src/main.tsx` - точка входа
- `client/public/sw.js` - Service Worker
- `server/index.ts` - серверная часть
- `server/routes.ts` - API маршруты

## 🎯 Три способа развертывания

### 1. Полностью автоматический (Рекомендуется)

Просто загрузите обновленные файлы на сервер:

```bash
# Загрузка файлов (любым способом)
git pull origin main
# или
scp -r ./client/ user@server:/path/to/app/
# или
rsync -avz ./server/ user@server:/path/to/app/

# Никаких дополнительных действий не требуется!
```

**Что произойдет:**
- Система автоматически обнаружит изменения файлов
- Пользователи получат уведомление через 30 секунд
- Кеш будет очищен автоматически

### 2. Полуавтоматический (С скриптом)

Используйте скрипт для дополнительной настройки:

```bash
# Запуск автоматического развертывания
node auto-deploy.js

# Система обновит:
# - BUILD_TIMESTAMP в Service Worker
# - BUILD_TIME в переменных окружения
# - Сгенерирует новый app hash
```

### 3. Ручной (Только при необходимости)

Если нужен полный контроль:

```bash
# 1. Обновите timestamp в sw.js
BUILD_TIMESTAMP = '20250113-2100'; // Текущее время

# 2. Установите переменную окружения
export BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

# 3. Перезапустите сервер
pm2 restart your-app
```

## 🔧 Настройка на VPS

### Для автоматического развертывания

1. **Настройте git hooks** (опционально):
```bash
# В репозитории на сервере
cat > .git/hooks/post-receive << 'EOF'
#!/bin/bash
cd /path/to/your/app
npm install
node auto-deploy.js
pm2 restart your-app
EOF

chmod +x .git/hooks/post-receive
```

2. **Настройте cron для проверки обновлений** (если нужно):
```bash
# Добавьте в crontab
*/5 * * * * cd /path/to/your/app && node auto-deploy.js
```

### Для ручного развертывания

```bash
# 1. Загрузите файлы
git pull origin main

# 2. Обновите зависимости (если нужно)
npm install

# 3. Запустите скрипт развертывания
node auto-deploy.js

# 4. Перезапустите приложение
pm2 restart edahouse
```

## 🔍 Диагностика и тестирование

### Проверка работы системы

1. **Откройте тестовую страницу**: `/test-cache.html`
2. **Проверьте API**: `/api/version` - текущий хеш и версия
3. **Проверьте health**: `/api/health` - полная информация о системе

### Инструменты для отладки

```bash
# Проверка текущего хеша
curl http://localhost:5000/api/version

# Проверка здоровья системы
curl http://localhost:5000/api/health

# Проверка кешей в браузере
# Откройте DevTools → Application → Storage → Cache Storage
```

### Логи для отладки

```javascript
// В браузере (DevTools Console)
localStorage.getItem('app_hash'); // Текущий хеш
localStorage.getItem('build_time'); // Время сборки

// Service Worker логи
console.log('Текущий кеш:', CACHE_NAME);
```

## 📱 Пользовательский опыт

### Что видят пользователи

1. **Автоматическое уведомление**: Желтая полоса сверху "Доступно обновление"
2. **Кнопка обновления**: "Обновить приложение" для немедленного обновления
3. **Автоматическая очистка**: Кеш очищается без участия пользователя

### Администраторы

- **Админ-панель**: Раздел "Управление кешем" в системных настройках
- **Принудительная очистка**: Кнопка "Очистить кеш приложения"
- **Статистика**: Информация о версии и времени сборки

## 🛠️ Расширенные возможности

### Настройка интервала проверки

```javascript
// В cache-buster.tsx, изменить интервал
const interval = setInterval(checkForUpdates, 60000); // 1 минута
```

### Добавление файлов для отслеживания

```javascript
// В server/routes.ts, в функции generateAppHash()
const filesToCheck = [
  'package.json',
  'client/src/App.tsx',
  'your-new-file.js', // Добавьте здесь
  // ...
];
```

### Кастомизация уведомлений

```javascript
// В cache-buster.tsx, изменить текст уведомления
const message = "Новая версия доступна!"; // Ваш текст
```

## 📋 Чек-лист для развертывания

- [ ] Файлы загружены на сервер
- [ ] Зависимости обновлены (`npm install`)
- [ ] Скрипт развертывания запущен (`node auto-deploy.js`)
- [ ] Сервер перезапущен (`pm2 restart`)
- [ ] Проверен `/api/version` для нового хеша
- [ ] Протестирован `/test-cache.html`
- [ ] Пользователи получили уведомление

## 🚨 Устранение неполадок

### Проблема: Пользователи не получают уведомления

**Решение:**
1. Проверьте `/api/version` - изменился ли `appHash`
2. Убедитесь, что файлы действительно изменились
3. Запустите `node auto-deploy.js` для принудительного обновления

### Проблема: Кеш не очищается

**Решение:**
1. Используйте админ-панель → "Очистить кеш приложения"
2. Проверьте Service Worker в DevTools
3. Перезапустите сервер с новым BUILD_TIME

### Проблема: Система не определяет изменения

**Решение:**
1. Проверьте, что файлы из `filesToCheck` действительно изменились
2. Убедитесь, что время модификации файлов обновилось
3. Запустите `touch` для принудительного обновления времени файлов

## 🎉 Преимущества новой системы

✅ **Автоматическое определение изменений** - не нужно помнить про обновление timestamp  
✅ **Мгновенные уведомления** - пользователи узнают об обновлениях через 30 секунд  
✅ **Надежная очистка кеша** - автоматическая очистка старых кешей  
✅ **Простое развертывание** - просто загрузите файлы  
✅ **Диагностические инструменты** - полная информация о состоянии системы  
✅ **Обратная совместимость** - работает с существующими методами развертывания  

**Теперь вы можете просто загружать файлы на сервер, и система сама позаботится об уведомлении пользователей!**