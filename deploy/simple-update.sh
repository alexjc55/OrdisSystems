#!/bin/bash

# =============================================================================
# –ü–†–û–°–¢–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï VPS –ë–ï–ó –ú–ò–ì–†–ê–¶–ò–ô
# =============================================================================
# –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–¥, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

set -e

echo "üîÑ –ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ eDAHouse –Ω–∞ VPS"
echo "====================================="

VPS_PATH="/var/www/ordis_co_il_usr/data/www/edahouse.ordis.co.il"
cd "$VPS_PATH"

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 stop edahouse || true

# 2. –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üíæ –ë—ç–∫–∞–ø –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
if [ -d "uploads" ]; then
    cp -r uploads uploads_backup_$(date +%Y%m%d_%H%M%S)
fi

# 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
git pull origin main

# 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install --production=false

# 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ uploads..."
if [ -d "uploads_backup_"* ]; then
    LATEST_BACKUP=$(ls -t uploads_backup_* | head -1)
    cp -r "$LATEST_BACKUP"/* uploads/ 2>/dev/null || true
fi

# 6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î (–µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
echo "üóÑÔ∏è  –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã..."
npx drizzle-kit push || echo "‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ö–µ–º—É –ë–î"

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start ecosystem.config.cjs

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞
echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥..."
sleep 10

pm2 status
curl -s http://localhost:5000/api/health || echo "–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

echo ""
echo "‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://edahouse.ordis.co.il"