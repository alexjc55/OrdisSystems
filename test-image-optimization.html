<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 20px 0; }
        .results { display: none; margin: 20px 0; padding: 20px; background: #f5f5f5; }
        .image-preview { max-width: 300px; margin: 10px; border: 1px solid #ddd; }
        .stats { background: white; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h1>
    
    <div class="upload-area">
        <input type="file" id="imageInput" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('imageInput').click()">
            üì∑ –í—ã–±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        </button>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é</p>
    </div>

    <div id="loginSection" style="display: none; background: #ffe6e6; padding: 15px; margin: 10px 0;">
        <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è</h3>
        <input type="text" id="username" placeholder="admin" value="admin">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="admin">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
    </div>

    <div class="upload-area">
        <button onclick="optimizeAllImages()" id="optimizeAllBtn">
            üîÑ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        </button>
        <p>–°–æ–∑–¥–∞–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏ –º–∏–Ω–∏–∞—Ç—é—Ä—ã –¥–ª—è –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø–∞–ø–∫–µ uploads/images</p>
    </div>

    <div id="results" class="results">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h2>
        <div id="imageResults"></div>
    </div>
    
    <div id="bulkResults" class="results">
        <h2>üîÑ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Å—Å–æ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h2>
        <div id="bulkImageResults"></div>
    </div>

    <script>
        let isAuthenticated = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        fetch('/api/auth/user')
            .then(response => {
                if (response.ok) {
                    isAuthenticated = true;
                    return response.json();
                } else {
                    document.getElementById('loginSection').style.display = 'block';
                    throw new Error('Not authenticated');
                }
            })
            .then(user => {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω:', user.username);
            })
            .catch(error => {
                console.log('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
            });

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    isAuthenticated = true;
                    document.getElementById('loginSection').style.display = 'none';
                    alert('‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        document.getElementById('imageInput').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!isAuthenticated) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
            const originalSize = (file.size / 1024).toFixed(1);
            console.log(`üì∏ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: ${file.name} (${originalSize}KB)`);

            // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
            const formData = new FormData();
            formData.append('image', file);

            try {
                const startTime = Date.now();
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadTime = Date.now() - startTime;

                if (response.ok) {
                    const result = await response.json();
                    showResults(file, result, uploadTime);
                } else {
                    const error = await response.json();
                    alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
                }
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            }
        });

        function showResults(originalFile, result, uploadTime) {
            const resultsDiv = document.getElementById('results');
            const imageResults = document.getElementById('imageResults');
            
            const originalSize = (originalFile.size / 1024).toFixed(1);
            
            imageResults.innerHTML = `
                <div class="stats">
                    <h3>‚è±Ô∏è –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${uploadTime}ms</h3>
                </div>
                
                <div class="stats">
                    <h3>üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª</h3>
                    <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${originalFile.name}</p>
                    <p><strong>–†–∞–∑–º–µ—Ä:</strong> ${originalSize}KB</p>
                    <p><strong>–¢–∏–ø:</strong> ${originalFile.type}</p>
                </div>

                <div class="stats">
                    <h3>‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h3>
                    <p><strong>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</strong> <a href="${result.imageUrl}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></p>
                    <p><strong>–ú–∏–Ω–∏–∞—Ç—é—Ä–∞:</strong> <a href="${result.thumbnailUrl}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></p>
                    <p><strong>–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</strong> <a href="${result.originalUrl}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></p>
                </div>

                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div>
                        <h4>üñºÔ∏è –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ (800px max)</h4>
                        <img src="${result.imageUrl}" class="image-preview" alt="–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ">
                    </div>
                    <div>
                        <h4>üîç –ú–∏–Ω–∏–∞—Ç—é—Ä–∞ (200x200px)</h4>
                        <img src="${result.thumbnailUrl}" class="image-preview" alt="–ú–∏–Ω–∏–∞—Ç—é—Ä–∞">
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
            
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏:', result);
        }

        async function optimizeAllImages() {
            if (!isAuthenticated) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
                return;
            }

            const optimizeAllBtn = document.getElementById('optimizeAllBtn');
            optimizeAllBtn.disabled = true;
            optimizeAllBtn.textContent = 'üîÑ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...';

            try {
                const startTime = Date.now();
                
                const response = await fetch('/api/admin/optimize-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const processTime = Date.now() - startTime;

                if (response.ok) {
                    const result = await response.json();
                    showBulkResults(result, processTime);
                } else {
                    const error = await response.json();
                    alert(`‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                }
            } catch (error) {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
            } finally {
                optimizeAllBtn.disabled = false;
                optimizeAllBtn.textContent = 'üîÑ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
            }
        }

        function showBulkResults(result, processTime) {
            const bulkResultsDiv = document.getElementById('bulkResults');
            const bulkImageResults = document.getElementById('bulkImageResults');
            
            bulkImageResults.innerHTML = `
                <div class="stats">
                    <h3>‚è±Ô∏è –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${(processTime / 1000).toFixed(1)} —Å–µ–∫—É–Ω–¥</h3>
                </div>
                
                <div class="stats">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
                    <p><strong>–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</strong> ${result.totalFiles}</p>
                    <p><strong>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${result.processed}</p>
                    <p><strong>–û—à–∏–±–æ–∫:</strong> ${result.errors}</p>
                    <p><strong>–ü—Ä–æ–ø—É—â–µ–Ω–æ:</strong> ${result.totalFiles - result.processed - result.errors} (—É–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã)</p>
                </div>

                <div class="stats">
                    <h3>üíæ –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞</h3>
                    <p><strong>–≠–∫–æ–Ω–æ–º–∏—è:</strong> ${result.totalSavingsMB} MB (${result.totalSavingsKB} KB)</p>
                    <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${result.message}</p>
                </div>
            `;
            
            bulkResultsDiv.style.display = 'block';
            
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Å—Å–æ–≤–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:', result);
        }
    </script>
</body>
</html>