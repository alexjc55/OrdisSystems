import XLSX from 'xlsx';
import fs from 'fs';

// Расширенный словарь переводов с русского на иврит
function translateToHebrew(russianText) {
  const translations = {
    // Салаты и названия блюд
    'Оливье': 'אוליווייה',
    'Винегрет': 'וינגרט',
    'Мимоза': 'מימוזה',
    'Салат из капусты': 'סלט כרוב',
    'Салат свежий с редиской': 'סלט טרי עם צנונית',
    'Салат из свеклы': 'סלט סלק',
    'Салат из моркови': 'סלט גזר',
    'Салат Цезарь': 'סלט קיסר',
    
    // Мясные блюда
    'Котлеты': 'קציצות',
    'Паргит': 'פרגית',
    'Крылышки': 'כנפיים',
    'Окорочка': 'עוף שלם',
    'Тефтели': 'קציצות ברוטב',
    'Гуляш': 'גולאש',
    'Плов': 'פלאו',
    'Плов зеленый': 'פלאו ירוק',
    
    // Выпечка
    'Пирожок с Капустой': 'פירושקי עם כרוב',
    'Пирожок с Картошкой': 'פירושקי עם תפוחי אדמה',
    'Пирожок с Яблоком': 'פירושקי עם תפוח',
    'Пирожок с Зеленым Луком и Яйцом': 'פירושקי עם בצל ירוק וביצה',
    
    // Супы
    'Борщ': 'בורש',
    'Суп дня': 'מרק היום',
    
    // Блинчики
    'Блинчики с Куриной Грудкой и Сыром': 'בלינצ\'ס עם חזה עוף וגבינה',
    'Блинчики с Мясом': 'בלינצ\'ס עם בשר',
    'Сырники': 'סירניקי',
    
    // Категории
    'Гарниры': 'תוספות',
    'Супы': 'מרקים',
    'Выпечка и десерты': 'מאפים וקינוחים',
    'Пирожки': 'פירושקי',
    'Горячие блюда': 'מנות חמות',
    'Салаты': 'סלטים',
    
    // Описания блюд
    'Классический салат с мясом, картофелем, морковью, яйцами и горошком': 'סלט קלאסי עם בשר, תפוחי אדמה, גזר, ביצים ואפונה',
    'Традиционный русский салат со свеклой, морковью и квашеной капустой': 'סלט רוסי מסורתי עם סלק, גזר וכרוב כבוש',
    'Нежный слоеный салат с рыбой, яйцами и сыром': 'סלט רך ושכבות עם דג, ביצים וגבינה',
    'Свежая капуста с морковью и зеленью': 'כרוב טרי עם גזר וירוקים',
    'Хрустящий салат из огурцов, редиски и зелени': 'סלט פריך עם מלפפונים, צנונית וירוקים',
    'Вареная свекла с чесноком и майонезом': 'סלק מבושל עם שום ומיונז',
    'Корейская морковка с пряными специями': 'גזר קוריאני עם תבלינים חריפים',
    'Маринованные грибы с корейскими специями': 'פטריות כבושות עם תבלינים קוריאניים',
    'Маринованные баклажаны с чесноком и кориандром': 'חצילים כבושים עם שום וכוסברה',
    'Острая закуска из помидоров, перца и специй': 'מזון חריף מעגבניות, פלפל ותבלינים',
    'Классический салат с курицей, пармезаном и соусом цезарь': 'סלט קלאסי עם עוף, פרמזן ורוטב קיסר',
    
    // Мясные блюда - описания
    'Домашние мясные котлеты из говядины и свинины': 'קציצות בשר ביתיות מבקר וחזיר',
    'Куриное филе в панировке, жаренное до золотистой корочки': 'פילה עוף בציפוי, מטוגן עד קרום זהוב',
    'Сочные куриные крылышки в медово-горчичном соусе': 'כנפי עוף עסיסיות ברוטב דבש וחרדל',
    'Запеченные куриные окорочка с травами и специями': 'ירכי עוף אפויות עם עשבי תיבול ותבלינים',
    'Нежные мясные шарики в томатном соусе': 'כדורי בשר רכים ברוטב עגבניות',
    'Тушеное мясо с овощами в пряном соусе': 'בשר מבושל עם ירקות ברוטב מתובל',
    'Классический узбекский плов с мясом и морковью': 'פלאו אוזבקי קלאסי עם בשר וגזר',
    
    // Выпечка - описания
    'Домашний пирожок с традиционной капустной начинкой': 'פירושקי ביתי עם מילוי כרוב מסורתי',
    'Домашний пирожок с нежной картофельной начинкой и зеленью': 'פירושקי ביתי עם מילוי תפוחי אדמה רך וירוקים',
    'Сладкий пирожок с ароматной яблочной начинкой и корицей': 'פירושקי מתוק עם מילוי תפוח ארומטי וקינמון',
    'Традиционный пирожок с начинкой из свежего зеленого лука и вареных яиц': 'פירושקי מסורתי עם מילוי בצל ירוק טרי וביצים מבושלות',
    
    // Супы - описания
    'Традиционный украинский борщ со сметаной': 'בורש אוקראיני מסורתי עם שמנת חמוצה',
    
    // Блинчики - описания
    'Сочная начинка из нежной куриной грудки, плавленого сыра, завернутая в тонкие и румяные блинчики. Прекрасный перекус и полноценное второе блюдо во время обеда.': 'מילוי עסיסי מחזה עוף רך, גבינה מומסת, עטוף בבלינצ\'ס דקים וזהובים. חטיף מושלם ומנה שנייה מלאה בזמן הצהריים.',
    'Традиционное русское лакомство – тонкие и румяные блинчики. Блинчики с богатой мясной начинкой станут прекрасным перекусом или полноценным вторым блюдом на завтрак או обед.': 'מעדן רוסי מסורתי - בלינצ\'ס דקים וזהובים. בלינצ\'ס עם מילוי בשר עשיר יהיו חטיף מושלם או מנה שנייה מלאה לארוחת בוקר או צהריים.',
    
    // Категории - описания
    'Каши, картофель, овощи': 'דייסות, תפוחי אדמה, ירקות',
    'Первые блюда': 'מנות ראשונות',
    'Блинчики, сырники, корндоги': 'בלינצ\'ס, סירניקי, קורן דוג',
    'Свежие пирожки с разными начинками': 'פירושקי טריים עם מילויים שונים',
    'Основные блюда на развес': 'מנות עיקריות במשקל',
    'Салаты и закуски': 'סלטים ומזנונים',
    'Свежие салаты и холодные закуски': 'סלטים טריים ומזנונים קרים',
    
    // Баннеры и слайдеры
    'Вкусный борщ как у мамы': 'בורש טעים כמו של אמא',
    'Всегда актуально, всегда вкусно!': 'תמיד רלוונטי, תמיד טעים!',
    'Дополнят любое блюдо': 'ישלימו כל מנה',
    'Праздник каждый день!': 'חג בכל יום!',
    'Выбор для идеального завтрака': 'בחירה לארוחת בוקר מושלמת',
    
    // Настройки магазина
    'Готовая еда с доставкой': 'אוכל מוכן עם משלוח',
    'Бесплатная доставка от 200₪': 'משלוח חינם מ-200₪',
    'Собственное производство': 'ייצור עצמי',
    'Стандартная тема': 'ערכת נושא סטנדרטית',
    'Базовая оранжевая тема сайта': 'ערכת נושא כתומה בסיסית לאתר',
    
    // Общие слова
    'Любимый': 'אהוב',
    'Куриные': 'עוף',
    'Грибы по-азиатски': 'פטריות באסיה',
    'Баклажаны по-азиатски': 'חצילים בסגנון אסייתי',
    'Аджика': 'אג\'יקה',
    'Абжерка': 'אבז\'רקה',
    
    // Дни и время
    'дня': 'היום',
    'каждый день': 'כל יום',
    'завтрака': 'ארוחת בוקר',
    'обед': 'צהריים',
    'завтрак': 'ארוחת בוקר',
    
    // Прилагательные для еды
    'Вкусный': 'טעים',
    'Свежий': 'טרי',
    'Домашний': 'ביתי',
    'Традиционный': 'מסורתי',
    'Классический': 'קלאסי',
    'Сочный': 'עסיסי',
    'Нежный': 'רך',
    'Острый': 'חריף',
    'Сладкий': 'מתוק',
    'Ароматный': 'ארומטי',
    'Хрустящий': 'פריך',
    'Слоеный': 'שכבות',
    'Маринованный': 'כבוש',
    'Запеченный': 'אפוי',
    'Жареный': 'מטוגן',
    'Тушеный': 'מבושל',
    'Вареный': 'מבושל',
    
    // Ингредиенты
    'мясо': 'בשר',
    'курица': 'עוף',
    'куриный': 'עוף',
    'говядина': 'בקר',
    'свинина': 'חזיר',
    'рыба': 'דג',
    'яйца': 'ביצים',
    'сыр': 'גבינה',
    'картофель': 'תפוחי אדמה',
    'картошка': 'תפוחי אדמה',
    'капуста': 'כרוב',
    'морковь': 'גזר',
    'свекла': 'סלק',
    'огурцы': 'מלפפונים',
    'помидоры': 'עגבניות',
    'перец': 'פלפל',
    'лук': 'בצל',
    'чеснок': 'שום',
    'зелень': 'ירוקים',
    'специи': 'תבלינים',
    'майонез': 'מיונז',
    'сметана': 'שמנת חמוצה',
    'соус': 'רוטב',
    'панировка': 'ציפוי',
    'начинка': 'מילוי',
    'корица': 'קינמון',
    'кориандр': 'כוסברה',
    'горошек': 'אפונה',
    'редиска': 'צנונית',
    'баклажаны': 'חצילים',
    'грибы': 'פטריות',
    'яблоко': 'תפוח',
    'травы': 'עשבי תיבול',
    'дрожжи': 'שמרים',
    'мука': 'קמח',
    'молоко': 'חלב',
    'масло': 'שמן',
    'сахар': 'סוכר',
    'соль': 'מלח',
    
    // Способы приготовления
    'жаренный': 'מטוגן',
    'запеченный': 'אפוי',
    'тушеное': 'מבושל',
    'вареный': 'מבושל',
    'маринованный': 'כבוש',
    'свежий': 'טרי',
    'горячий': 'חם',
    'холодный': 'קר',
    
    // Текстуры и качества
    'золотистой корочки': 'קרום זהוב',
    'медово-горчичном': 'דבש וחרדל',
    'томатном': 'עגבניות',
    'пряном': 'מתובל',
    'квашеной': 'כבוש',
    'плавленого': 'מומס',
    'корейскими': 'קוריאניים',
    'украинский': 'אוקראיני',
    'узбекский': 'אוזבקי',
    'русский': 'רוסי',
    'азиатски': 'אסיאתי',
    
    // Блюда и категории
    'салат': 'סלט',
    'суп': 'מרק',
    'блинчики': 'בלינצ\'ס',
    'пирожок': 'פירושקי',
    'котлеты': 'קציצות',
    'тефтели': 'קציצות ברוטב',
    'крылышки': 'כנפיים',
    'окорочка': 'ירכיים',
    'филе': 'פילה',
    'грудка': 'חזה',
    'шарики': 'כדורים',
    'закуска': 'מזנון',
    'гарнир': 'תוספת',
    'десерт': 'קינוח',
    'выпечка': 'מאפה',
    'блюдо': 'מנה',
    'еда': 'אוכל',
    'питание': 'תזונה',
    'кухня': 'מטבח',
    'меню': 'תפריט',
    'завтрак': 'ארוחת בוקר',
    'обед': 'צהריים',
    'ужин': 'ערב',
    'перекус': 'חטיф',
    'лакомство': 'מעדן',
    
    // Прочие общие слова
    'и': 'ו',
    'с': 'עם',
    'в': 'ב',
    'на': 'על',
    'из': 'מ',
    'для': 'ל',
    'как': 'כמו',
    'до': 'עד',
    'во время': 'בזמן',
    'или': 'או',
    'также': 'גם',
    'всегда': 'תמיד',
    'очень': 'מאוד',
    'самый': 'הכי',
    'лучший': 'הטוב ביותר',
    'идеальный': 'מושלם',
    'прекрасный': 'מושלם',
    'богатый': 'עשיר',
    'полноценный': 'מלא',
    'разными': 'שונים',
    'различными': 'שונים'
  };
  
  // Прямое совпадение
  if (translations[russianText]) {
    return translations[russianText];
  }
  
  // Перевод по словам с сохранением структуры
  let result = russianText;
  
  // Сначала попробуем найти длинные фразы
  const sortedKeys = Object.keys(translations).sort((a, b) => b.length - a.length);
  
  for (const key of sortedKeys) {
    if (result.includes(key)) {
      result = result.replace(new RegExp(key, 'gi'), translations[key]);
    }
  }
  
  return result;
}

// Функция для проверки, является ли строка ссылкой
function isURL(str) {
  if (!str || typeof str !== 'string') return false;
  return str.startsWith('http://') || 
         str.startsWith('https://') || 
         str.startsWith('www.') || 
         str.startsWith('/uploads/') ||
         str.startsWith('/assets/') ||
         str.startsWith('/@assets/') ||
         str.includes('.com') || 
         str.includes('.ru') || 
         str.includes('.co.il') ||
         str.includes('.jpg') ||
         str.includes('.png') ||
         str.includes('.webp') ||
         str.includes('.jpeg');
}

// Обработка файла
try {
  console.log('Читаем файл переводов...');
  const workbook = XLSX.readFile('attached_assets/translations_2025-08-26_1756220852157.xlsx');
  const sheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[sheetName];
  
  console.log('Конвертируем в JSON...');
  const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
  
  if (data.length === 0) {
    console.log('Файл пустой');
    process.exit(1);
  }
  
  // Находим индексы нужных колонок
  const headers = data[0];
  console.log('Заголовки:', headers);
  
  const russianIndex = headers.findIndex(h => h && (h.includes('Russian') || h.includes('RU')));
  const hebrewIndex = headers.findIndex(h => h && (h.includes('Hebrew') || h.includes('HE')));
  
  console.log(`Индекс русской колонки: ${russianIndex}`);
  console.log(`Индекс ивритской колонки: ${hebrewIndex}`);
  
  if (russianIndex === -1) {
    console.log('Колонка Russian (RU) не найдена');
    process.exit(1);
  }
  
  if (hebrewIndex === -1) {
    console.log('Колонка Hebrew (HE) не найдена');
    process.exit(1);
  }
  
  let translatedCount = 0;
  let skippedCount = 0;
  let urlCount = 0;
  let improvedCount = 0;
  
  // Обрабатываем каждую строку
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (!row) continue;
    
    const russianText = row[russianIndex];
    
    if (!russianText || russianText.trim() === '') {
      continue; // Пропускаем пустые ячейки
    }
    
    // Проверяем, является ли текст ссылкой
    if (isURL(russianText)) {
      console.log(`Строка ${i}: Пропускаем ссылку: ${russianText}`);
      row[hebrewIndex] = ''; // Оставляем пустой для ссылок
      urlCount++;
      continue;
    }
    
    // Переводим текст
    const hebrewTranslation = translateToHebrew(russianText.trim());
    
    // Проверяем, есть ли уже перевод
    if (row[hebrewIndex] && row[hebrewIndex].trim() !== '') {
      // Если наш перевод лучше существующего, обновляем
      if (hebrewTranslation !== russianText && hebrewTranslation.length > row[hebrewIndex].trim().length) {
        console.log(`Строка ${i}: Улучшаем перевод: "${row[hebrewIndex]}" -> "${hebrewTranslation}"`);
        row[hebrewIndex] = hebrewTranslation;
        improvedCount++;
      } else {
        console.log(`Строка ${i}: Перевод уже существует: ${row[hebrewIndex]}`);
        skippedCount++;
      }
      continue;
    }
    
    row[hebrewIndex] = hebrewTranslation;
    
    if (hebrewTranslation !== russianText) {
      console.log(`Строка ${i}: "${russianText}" -> "${hebrewTranslation}"`);
      translatedCount++;
    } else {
      console.log(`Строка ${i}: Перевод не найден для: "${russianText}"`);
    }
  }
  
  console.log(`\nОбработка завершена:`);
  console.log(`- Переведено новых: ${translatedCount} строк`);
  console.log(`- Улучшено существующих: ${improvedCount} строк`);
  console.log(`- Пропущено (уже переведено): ${skippedCount} строк`);
  console.log(`- Пропущено (ссылки): ${urlCount} строк`);
  
  // Сохраняем обновленный файл
  const newWorkbook = XLSX.utils.book_new();
  const newWorksheet = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, 'Translations');
  
  const outputFileName = 'attached_assets/translations_hebrew_enhanced_2025-08-26.xlsx';
  XLSX.writeFile(newWorkbook, outputFileName);
  
  console.log(`\nФайл сохранен как: ${outputFileName}`);
  
} catch (error) {
  console.error('Ошибка при обработке файла:', error);
  process.exit(1);
}