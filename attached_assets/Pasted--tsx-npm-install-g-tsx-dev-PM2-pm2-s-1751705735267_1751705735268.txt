# Установим tsx глобально если нужно
npm install -g tsx

# Запустим в dev режиме через PM2
pm2 start ecosystem.production.config.cjs

# Проверим FastPanel конфигурацию и исправим порт
echo "=== FastPanel конфигурация ==="
sudo cat /etc/nginx/fastpanel2-available/ordis_co_il_usr/edahouse.ordis.co.il.conf | grep proxy_pass

# Исправим порт в FastPanel конфигурации
sudo sed -i 's/proxy_pass.*localhost:[0-9]*/proxy_pass http:\/\/localhost:5000/g' /etc/nginx/fastpanel2-available/ordis_co_il_usr/edahouse.ordis.co.il.conf

# Перезагрузим Nginx
sudo nginx -t && sudo systemctl reload nginx

# Ждем запуска
sleep 10

# Проверяем работу
echo "🧪 Проверка локального порта:"
curl -s http://localhost:5000/api/health

echo "🧪 Проверка внешнего доступа:"
curl -s https://edahouse.ordis.co.il/api/health

pm2 status
[PM2] Applying action stopProcessId on app [edahouse](ids: [ 0 ])
[PM2] [edahouse](0) ✓
┌────┬─────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name        │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼─────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0  │ edahouse    │ default     │ 1.0.0   │ cluster │ 0        │ 0      │ 0    │ stopped   │ 0%       │ 0b       │ ord… │ disabled │
└────┴─────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
[PM2] Applying action deleteProcessId on app [edahouse](ids: [ 0 ])
[PM2] [edahouse](0) ✓
┌────┬───────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name      │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
└────┴───────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
npm error code EACCES
npm error syscall mkdir
npm error path /usr/lib/node_modules/tsx
npm error errno -13
npm error [Error: EACCES: permission denied, mkdir '/usr/lib/node_modules/tsx'] {
npm error   errno: -13,
npm error   code: 'EACCES',
npm error   syscall: 'mkdir',
npm error   path: '/usr/lib/node_modules/tsx'
npm error }
npm error
npm error The operation was rejected by your operating system.
npm error It is likely you do not have the permissions to access this file as the current user
npm error
npm error If you believe this might be a permissions issue, please double-check the
npm error permissions of the file and its containing directories, or try running
npm error the command again as root/Administrator.
npm error A complete log of this run can be found in: /var/www/ordis_co_il_usr/data/.npm/_logs/2025-07-05T08_54_39_389Z-debug-0.log
[PM2][WARN] Applications edahouse not running, starting...
[PM2][ERROR] Error: Script not found: /var/www/ordis_co_il_usr/data/www/edahouse.ordis.co.il/tsx
=== FastPanel конфигурация ===
        proxy_pass http://edahouse.ordis.co.il;
        proxy_pass http://edahouse.ordis.co.il;
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
🧪 Проверка локального порта:
🧪 Проверка внешнего доступа:
<html>
<head><title>502 Bad Gateway</title></head>
<body>
<center><h1>502 Bad Gateway</h1></center>
<hr><center>nginx/1.28.0</center>
</body>
</html>
┌────┬───────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name      │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
└────┴───────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘
ordis_co_il_usr@vxaorzmkzo:~/www/edahouse.ordis.co.il$
