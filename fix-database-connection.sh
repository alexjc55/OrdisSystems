#!/bin/bash

# ===================================================================
# –°–ö–†–ò–ü–¢ –ü–û–ò–°–ö–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö –ë–ê–ó–´ –î–ê–ù–ù–´–•
# ===================================================================

echo "üîç –ò—â–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() {
    echo -e "${BLUE}[i]${NC} $1"
}

print_found() {
    echo -e "${GREEN}[‚úì]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

echo "================================================================"
echo "1. –ü–†–û–í–ï–†–Ø–ï–ú –§–ê–ô–õ–´ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò"
echo "================================================================"

# –ò—â–µ–º .env —Ñ–∞–π–ª—ã
print_info "–ü–æ–∏—Å–∫ .env —Ñ–∞–π–ª–æ–≤..."
if [ -f ".env" ]; then
    print_found "–ù–∞–π–¥–µ–Ω .env —Ñ–∞–π–ª"
    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ .env (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π):"
    grep -E "(DATABASE|POSTGRES|PG)" .env | sed 's/=.*password.*/=***—Å–∫—Ä—ã—Ç–æ***/'
else
    print_warning ".env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo "================================================================"
echo "2. –ü–†–û–í–ï–†–Ø–ï–ú PM2 –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ"
echo "================================================================"

# –ò—â–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PM2
print_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 list 2>/dev/null || print_warning "PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω"

# –ò—â–µ–º ecosystem —Ñ–∞–π–ª—ã
if [ -f "ecosystem.config.js" ] || [ -f "ecosystem.config.cjs" ]; then
    print_found "–ù–∞–π–¥–µ–Ω ecosystem config:"
    ls -la ecosystem.config.*
    echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ (–±–µ–∑ –ø–∞—Ä–æ–ª–µ–π):"
    cat ecosystem.config.* 2>/dev/null | grep -E "(DATABASE|POSTGRES|PG)" | sed 's/password.*/password: "***—Å–∫—Ä—ã—Ç–æ***"/'
fi

echo "================================================================"
echo "3. –ü–†–û–í–ï–†–Ø–ï–ú –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò POSTGRESQL"
echo "================================================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PostgreSQL
print_info "–°—Ç–∞—Ç—É—Å PostgreSQL..."
sudo systemctl status postgresql 2>/dev/null | head -5 || print_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å PostgreSQL"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π PostgreSQL
print_info "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ PostgreSQL..."
sudo -u postgres psql -c "\du" 2>/dev/null || print_warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

echo "================================================================"
echo "4. –¢–ï–°–¢–ò–†–£–ï–ú –†–ê–ó–ù–´–ï –°–ü–û–°–û–ë–´ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø"
echo "================================================================"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
print_info "–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."

# –í–∞—Ä–∏–∞–Ω—Ç 1: –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç postgres
echo "–¢–µ—Å—Ç 1: sudo -u postgres psql"
if sudo -u postgres psql -c "SELECT version();" 2>/dev/null | head -1; then
    print_found "‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è postgres —Ä–∞–±–æ—Ç–∞–µ—Ç"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
    sudo -u postgres psql -c "\l" 2>/dev/null | grep -E "(edahouse|eDAHouse)" || echo "–ë–∞–∑–∞ edahouse –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
else
    print_warning "‚úó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è postgres –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
echo ""
echo "–¢–µ—Å—Ç 2: psql —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
if psql -h localhost -U postgres -c "SELECT version();" 2>/dev/null | head -1; then
    print_found "‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º postgres —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    print_warning "‚úó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º postgres –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

echo "================================================================"
echo "5. –°–û–ó–î–ê–ï–ú –ü–†–ê–í–ò–õ–¨–ù–£–Æ –°–¢–†–û–ö–£ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø"
echo "================================================================"

# –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
print_info "–ò—â–µ–º —Ä–∞–±–æ—á–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ..."

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
if sudo -u postgres psql -c "\l" | grep -i edahouse >/dev/null 2>&1; then
    DB_NAME=$(sudo -u postgres psql -c "\l" | grep -i edahouse | awk '{print $1}' | head -1)
    print_found "–ù–∞–π–¥–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DB_NAME"
    
    echo ""
    echo "–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ú–ò–ì–†–ê–¶–ò–ò:"
    echo "================================================================"
    echo "# –í–∞—Ä–∏–∞–Ω—Ç 1 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):"
    echo "sudo -u postgres psql -d $DB_NAME -f auto-migrate.sql"
    echo ""
    echo "# –í–∞—Ä–∏–∞–Ω—Ç 2:"  
    echo "psql -h localhost -U postgres -d $DB_NAME -f auto-migrate.sql"
    echo ""
    echo "# –í–∞—Ä–∏–∞–Ω—Ç 3 (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–æ–ª—å):"
    echo "PGPASSWORD='your_password' psql -h localhost -U postgres -d $DB_NAME -f auto-migrate.sql"
    echo "================================================================"
else
    print_warning "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö edahouse –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    echo ""
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–π—Ç–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤—Ä—É—á–Ω—É—é:"
    echo "sudo -u postgres psql -c '\l'"
fi

echo ""
echo "================================================================"
echo "6. –ü–û–ò–°–ö –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò –í –ü–†–û–ï–ö–¢–ï"
echo "================================================================"

# –ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–¥–µ
print_info "–ü–æ–∏—Å–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –∫–æ–¥–µ..."
grep -r -i "database\|postgres\|pg" . --include="*.js" --include="*.ts" --include="*.json" --include="*.env*" 2>/dev/null | grep -v node_modules | head -10

echo ""
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è."