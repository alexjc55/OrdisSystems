<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ iOS –∫–µ—à–∞ - eDAHouse</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #DC3545; }
        button.danger:hover { background: #c82333; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–µ—à–∞ iOS - eDAHouse</h1>
    
    <div class="card">
        <h2>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h2>
        <div id="deviceInfo"></div>
    </div>

    <div class="card">
        <h2>üîÑ –°—Ç–∞—Ç—É—Å Service Worker</h2>
        <div id="swStatus"></div>
        <button onclick="checkServiceWorker()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SW</button>
        <button onclick="unregisterSW()" class="danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å SW</button>
    </div>

    <div class="card">
        <h2>üíæ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–µ—à–∞</h2>
        <div id="cacheStatus"></div>
        <div class="grid">
            <button onclick="checkCaches()">üìã –°–ø–∏—Å–æ–∫ –∫–µ—à–µ–π</button>
            <button onclick="clearAllCaches()" class="danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button onclick="checkStorage()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</button>
            <button onclick="clearStorage()" class="danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</button>
        </div>
    </div>

    <div class="card">
        <h2>üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ API</h2>
        <div id="apiStatus"></div>
        <div class="grid">
            <button onclick="testAPI()">üß™ –¢–µ—Å—Ç API</button>
            <button onclick="testVersionAPI()">üì± –¢–µ—Å—Ç /api/version</button>
            <button onclick="testSettingsAPI()">‚öôÔ∏è –¢–µ—Å—Ç /api/settings</button>
        </div>
    </div>

    <div class="card">
        <h2>üîÑ –î–µ–π—Å—Ç–≤–∏—è –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º</h2>
        <div class="grid">
            <button onclick="performIOSCacheFix()" class="danger">üö® iOS: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞</button>
            <button onclick="forceReload()">üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞</button>
            <button onclick="resetApp()" class="danger">üÜò –°–±—Ä–æ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</button>
        </div>
        <div class="status warning">
            <strong>‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:</strong> "iOS: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞" –≤—ã–ø–æ–ª–Ω–∏—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –æ—á–∏—Å—Ç–∫—É –≤—Å–µ—Ö –∫–µ—à–µ–π –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
        </div>
    </div>

    <div class="card">
        <h2>üìù –ñ—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logMessages = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const formattedMessage = `[${timestamp}] ${message}`;
            logMessages.push(formattedMessage);
            
            console.log(formattedMessage);
            document.getElementById('log').textContent = logMessages.join('\n');
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }

        function clearLog() {
            logMessages = [];
            document.getElementById('log').textContent = '';
        }

        function updateDeviceInfo() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isWebApp = window.navigator.standalone === true;
            
            document.getElementById('deviceInfo').innerHTML = `
                <div class="status ${isIOS ? 'warning' : 'success'}">
                    <strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong> ${isIOS ? 'iOS —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ' : '–ù–µ iOS'}<br>
                    <strong>User Agent:</strong> <code>${navigator.userAgent}</code><br>
                    <strong>PWA —Ä–µ–∂–∏–º:</strong> ${isStandalone || isWebApp ? '–î–∞' : '–ù–µ—Ç'}<br>
                    <strong>Standalone:</strong> ${isWebApp ? '–î–∞' : '–ù–µ—Ç'}<br>
                    <strong>Display mode:</strong> ${isStandalone ? 'Standalone' : 'Browser'}
                </div>
            `;
            
            log(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${isIOS ? 'iOS' : 'Other'}, PWA: ${isStandalone || isWebApp}`);
        }

        async function checkServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    const ready = await navigator.serviceWorker.ready;
                    
                    let status = '';
                    if (registration) {
                        status = `
                            <div class="status success">
                                <strong>Service Worker:</strong> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω<br>
                                <strong>Scope:</strong> <code>${registration.scope}</code><br>
                                <strong>State:</strong> ${registration.active ? registration.active.state : '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ'}<br>
                                <strong>Script URL:</strong> <code>${registration.active ? registration.active.scriptURL : '–ù/–î'}</code>
                            </div>
                        `;
                        log('Service Worker –Ω–∞–π–¥–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω');
                    } else {
                        status = '<div class="status error">Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</div>';
                        log('Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    }
                    
                    document.getElementById('swStatus').innerHTML = status;
                } catch (error) {
                    const errorMsg = `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ SW: ${error.message}`;
                    document.getElementById('swStatus').innerHTML = `<div class="status error">${errorMsg}</div>`;
                    log(errorMsg, 'error');
                }
            } else {
                const msg = 'Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                document.getElementById('swStatus').innerHTML = `<div class="status error">${msg}</div>`;
                log(msg, 'error');
            }
        }

        async function unregisterSW() {
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        log(`SW —É–¥–∞–ª–µ–Ω: ${registration.scope}`);
                    }
                    document.getElementById('swStatus').innerHTML = '<div class="status success">–í—Å–µ Service Workers —É–¥–∞–ª–µ–Ω—ã</div>';
                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è SW: ${error.message}`, 'error');
                }
            }
        }

        async function checkCaches() {
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    let status = `<strong>–ù–∞–π–¥–µ–Ω–æ –∫–µ—à–µ–π:</strong> ${cacheNames.length}<br>`;
                    
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();
                        status += `<code>${cacheName}</code> (${keys.length} —Ñ–∞–π–ª–æ–≤)<br>`;
                    }
                    
                    document.getElementById('cacheStatus').innerHTML = `<div class="status info">${status}</div>`;
                    log(`–ù–∞–π–¥–µ–Ω–æ ${cacheNames.length} –∫–µ—à–µ–π`);
                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–µ—à–µ–π: ${error.message}`, 'error');
                }
            }
        }

        async function clearAllCaches() {
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    let cleared = 0;
                    
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        cleared++;
                        log(`–ö–µ—à —É–¥–∞–ª–µ–Ω: ${cacheName}`);
                    }
                    
                    document.getElementById('cacheStatus').innerHTML = `<div class="status success">–£–¥–∞–ª–µ–Ω–æ ${cleared} –∫–µ—à–µ–π</div>`;
                    log(`–í—Å–µ –∫–µ—à–∏ –æ—á–∏—â–µ–Ω—ã (${cleared})`);
                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–µ–π: ${error.message}`, 'error');
                }
            }
        }

        function checkStorage() {
            const localStorage_size = JSON.stringify(localStorage).length;
            const sessionStorage_size = JSON.stringify(sessionStorage).length;
            
            let status = `
                <strong>localStorage:</strong> ${localStorage_size} –±–∞–π—Ç (${Object.keys(localStorage).length} –∫–ª—é—á–µ–π)<br>
                <strong>sessionStorage:</strong> ${sessionStorage_size} –±–∞–π—Ç (${Object.keys(sessionStorage).length} –∫–ª—é—á–µ–π)<br><br>
                <strong>localStorage —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:</strong><br>
            `;
            
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    status += `<code>${key}</code>: ${localStorage.getItem(key)}<br>`;
                }
            }
            
            document.getElementById('cacheStatus').innerHTML = `<div class="status info">${status}</div>`;
            log(`localStorage: ${Object.keys(localStorage).length} –∫–ª—é—á–µ–π, sessionStorage: ${Object.keys(sessionStorage).length} –∫–ª—é—á–µ–π`);
        }

        function clearStorage() {
            const localCount = Object.keys(localStorage).length;
            const sessionCount = Object.keys(sessionStorage).length;
            
            localStorage.clear();
            sessionStorage.clear();
            
            document.getElementById('cacheStatus').innerHTML = '<div class="status success">–í—Å–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –æ—á–∏—â–µ–Ω—ã</div>';
            log(`–û—á–∏—â–µ–Ω–æ: localStorage (${localCount}), sessionStorage (${sessionCount})`);
        }

        async function testAPI() {
            const endpoints = ['/api/version', '/api/settings', '/api/categories'];
            let results = '<strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API:</strong><br>';
            
            for (const endpoint of endpoints) {
                try {
                    const start = Date.now();
                    const response = await fetch(endpoint + '?' + Date.now());
                    const time = Date.now() - start;
                    const status = response.ok ? 'success' : 'error';
                    results += `<span class="status ${status}">${endpoint}: ${response.status} (${time}ms)</span><br>`;
                    log(`API ${endpoint}: ${response.status} –∑–∞ ${time}ms`);
                } catch (error) {
                    results += `<span class="status error">${endpoint}: –û—à–∏–±–∫–∞ - ${error.message}</span><br>`;
                    log(`API ${endpoint}: –û—à–∏–±–∫–∞ - ${error.message}`, 'error');
                }
            }
            
            document.getElementById('apiStatus').innerHTML = results;
        }

        async function testVersionAPI() {
            try {
                const response = await fetch('/api/version?' + Date.now());
                const data = await response.json();
                
                document.getElementById('apiStatus').innerHTML = `
                    <div class="status success">
                        <strong>/api/version:</strong> OK<br>
                        <strong>Version:</strong> ${data.version}<br>
                        <strong>App Hash:</strong> ${data.appHash}<br>
                        <strong>Build Time:</strong> ${data.buildTime}
                    </div>
                `;
                log(`Version API: v${data.version}, hash=${data.appHash}`);
            } catch (error) {
                document.getElementById('apiStatus').innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ version API: ${error.message}</div>`;
                log(`Version API –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function testSettingsAPI() {
            try {
                const response = await fetch('/api/settings?' + Date.now());
                const data = await response.json();
                
                document.getElementById('apiStatus').innerHTML = `
                    <div class="status success">
                        <strong>/api/settings:</strong> OK<br>
                        <strong>Store Name:</strong> ${data.storeName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}<br>
                        <strong>Settings ID:</strong> ${data.id}
                    </div>
                `;
                log(`Settings API: store=${data.storeName || 'N/A'}`);
            } catch (error) {
                document.getElementById('apiStatus').innerHTML = `<div class="status error">–û—à–∏–±–∫–∞ settings API: ${error.message}</div>`;
                log(`Settings API –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function performIOSCacheFix() {
            log('üö® –ù–∞—á–∏–Ω–∞–µ–º iOS-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –æ—á–∏—Å—Ç–∫—É –∫–µ—à–µ–π...', 'warning');
            
            try {
                // 1. –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–µ—à–µ–π
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    log(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${cacheNames.length} –∫–µ—à–µ–π`);
                }

                // 2. –£–¥–∞–ª–µ–Ω–∏–µ Service Worker
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    log(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${registrations.length} Service Workers`);
                }

                // 3. –û—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â –Ω–æ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const preserveKeys = ['last_update', 'last_processed_hash', 'app_hash', 'app_version', 'build_time'];
                const preserved = {};
                preserveKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        preserved[key] = localStorage.getItem(key);
                    }
                });

                localStorage.clear();
                sessionStorage.clear();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                Object.entries(preserved).forEach(([key, value]) => {
                    localStorage.setItem(key, value);
                });
                log(`‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–∞ –æ—á–∏—â–µ–Ω—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${Object.keys(preserved).length} –∫–ª—é—á–µ–π`);

                // 4. –û—á–∏—Å—Ç–∫–∞ IndexedDB –¥–ª—è iOS
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        await Promise.all(databases.map(db => {
                            if (db.name) {
                                return new Promise((resolve, reject) => {
                                    const deleteReq = indexedDB.deleteDatabase(db.name);
                                    deleteReq.onsuccess = () => resolve();
                                    deleteReq.onerror = () => reject(deleteReq.error);
                                });
                            }
                        }));
                        log(`‚úÖ IndexedDB –æ—á–∏—â–µ–Ω`);
                    } catch (error) {
                        log(`‚ö†Ô∏è IndexedDB: ${error.message}`, 'warning');
                    }
                }

                log('üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –¥–ª—è iOS...', 'warning');
                
                // 5. iOS-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
                setTimeout(() => {
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    if (isIOS) {
                        const newUrl = window.location.href.split('?')[0] + '?ios_cache_fix=' + Date.now() + '&debug=true';
                        window.location.replace(newUrl);
                    } else {
                        window.location.reload(true);
                    }
                }, 1000);

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ iOS-–æ—á–∏—Å—Ç–∫–∏: ${error.message}`, 'error');
            }
        }

        function forceReload() {
            log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...', 'warning');
            window.location.href = window.location.href + '?force_reload=' + Date.now();
        }

        function resetApp() {
            log('üÜò –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'warning');
            
            // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ–≥–æ
            localStorage.clear();
            sessionStorage.clear();
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–µ—à–µ–π –∏ SW –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
            Promise.all([
                caches.keys().then(names => Promise.all(names.map(name => caches.delete(name)))),
                navigator.serviceWorker.getRegistrations().then(regs => Promise.all(regs.map(reg => reg.unregister())))
            ]).finally(() => {
                // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π
                window.location.href = '/?reset=' + Date.now();
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ iOS –∫–µ—à–∞');
            updateDeviceInfo();
            checkServiceWorker();
            checkCaches();
            checkStorage();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–∏ –ª–∏ –º—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ iOS-—Ñ–∏–∫—Å–∞
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('ios_cache_fix')) {
                log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ—Å–ª–µ iOS cache fix', 'success');
                document.body.style.background = '#d4edda';
                setTimeout(() => {
                    document.body.style.background = '#f5f5f5';
                }, 3000);
            }
            if (urlParams.get('reset')) {
                log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ', 'success');
            }
        });
    </script>
</body>
</html>